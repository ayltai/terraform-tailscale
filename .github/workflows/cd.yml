name: CD
on:
  release:
    types:
      - created
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: hashicorp/setup-terraform@v1
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
      - run: terraform init -lock-timeout=5m
        env:
          TF_IN_AUTOMATION: true
          TF_WORKSPACE: main
          TF_VAR_aws_access_key: ${{ secrets.AWS_ACCESS_KEY }}
          TF_VAR_aws_secret_key: ${{ secrets.AWS_SECRET_KEY }}
          TF_VAR_tailscale_api_key: ${{ secrets.TAILSCALE_API_KEY }}
          TF_VAR_tailscale_tailnet: ${{ secrets.TAILSCALE_TAILNET }}
      - run: terraform apply -auto-approve -input=false -lock-timeout=5m
        env:
          TF_IN_AUTOMATION: true
          TF_WORKSPACE: main
          TF_VAR_aws_access_key: ${{ secrets.AWS_ACCESS_KEY }}
          TF_VAR_aws_secret_key: ${{ secrets.AWS_SECRET_KEY }}
          TF_VAR_tailscale_api_key: ${{ secrets.TAILSCALE_API_KEY }}
          TF_VAR_tailscale_tailnet: ${{ secrets.TAILSCALE_TAILNET }}
